<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>To‑Do List (Preto e Branco)</title>
  
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="style.css?v=1.0.1" />
</head>
<body>
  <div id="app" class="frame" role="application">
    <header class="appbar">
      <div class="appbar-left">
        <button id="globalBackBtn" class="back-btn" type="button" aria-label="Voltar" hidden>←</button>
        <div class="app-title" id="appTitle">To‑Do</div>
      </div>
      <div class="appbar-right">
        <button id="appMenuBtn" class="icon-btn" type="button" aria-label="Mais opções" aria-haspopup="true" aria-expanded="false" hidden>⋮</button>
        <div id="appMenu" class="app-menu" role="menu" hidden>
          <button id="shareListAction" class="app-menu-item" type="button" role="menuitem">Compartilhar lista</button>
          <button id="resetAppAction" class="app-menu-item" type="button" role="menuitem">Resetar app</button>
          <button id="deleteListAction" class="app-menu-item" type="button" role="menuitem">Excluir Lista</button>
        </div>
      </div>
    </header>
    <div id="menuBackdrop" class="menu-backdrop" aria-hidden="true" style="display:none"></div>

    <!-- Screen: Lists -->
    <main id="screenLists" class="screen active" aria-label="Listas">
      <div class="lists" id="listsContainer">
        <div class="centered-empty" id="noLists">Nenhuma lista criada. Toque em "Nova Lista" para começar.</div>
      </div>
      <button id="btnImportCode" class="code-btn" aria-haspopup="dialog"><span class="icon">+</span><span>Código</span></button>
      <button id="btnNewList" class="new-list-btn" aria-haspopup="dialog"><span class="icon">+</span><span>Nova Lista</span></button>
    </main>

    <!-- Screen: Single List -->
    <section id="screenListDetail" class="screen" aria-label="Detalhes da Lista">
      <div class="list-header">
        <div style="display:flex;align-items:center;gap:8px">
          <div id="currentListName" class="list-name" tabindex="0" role="button" aria-haspopup="dialog">Título</div>
        </div>
      </div>

      <div class="tasks" id="tasksContainer" aria-live="polite"></div>

      <!-- completed group -->
      <div id="completedGroup" style="display:none">
        <div id="completedHeader" class="completed-header" role="button" tabindex="0">
          <span id="chev">▾</span>
          <span>Concluída</span>
          <span class="count" id="completedCount">0</span>
        </div>
        <div id="completedList" class="tasks"></div>
      </div>

      <!-- Floating + (right) -->
      <button id="openComposer" class="fab" aria-label="Adicionar">+</button>
    </section>

    <!-- Screen: Task Detail -->
    <section id="screenTaskDetail" class="screen" aria-label="Tarefa">
      <div class="task-detail">
        <div class="task-detail-row" id="taskDetailRow">
          <button id="taskDetailCheckbox" class="checkbox-round" aria-label="Concluir tarefa"></button>
          <div id="taskDetailText" class="text" contenteditable="true" spellcheck="false" aria-label="Editar tarefa"></div>
        </div>
      </div>
    </section>

    <!-- Modal (Create / Rename) -->
    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="modal" role="document">
        <h3 id="modalTitle">Nova Lista</h3>
        <div class="modal-body">
          <input id="listNameInput" type="text" placeholder="Nome da lista" aria-label="Nome da lista" />
        </div>
        <div class="actions">
          <button id="modalCancel" class="btn">Cancelar</button>
          <button id="modalPrimary" class="btn primary" disabled>Criar lista</button>
        </div>
      </div>
    </div>

    <!-- Code Import Modal -->
    <div id="codeBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="modal" role="document">
        <h3 id="codeModalTitle">Código</h3>
        <div class="modal-body">
          <div class="code-inputs" role="group" aria-label="Código de 6 dígitos">
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 1" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 2" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 3" maxlength="1" />
            <span class="code-gap" aria-hidden="true" style="width:10px"></span>
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 4" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 5" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 6" maxlength="1" />
          </div>
        </div>
        <div class="actions">
          <button id="codeCancel" class="btn">Cancelar</button>
          <button id="codeImport" class="btn primary">Importar lista</button>
        </div>
      </div>
    </div>

    <!-- Share Code Dialog -->
    <div id="shareBackdrop" class="share-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="share-dialog" role="document">
        <h3 class="share-title">Compartilhar Lista</h3>
        <p class="share-instructions">Compartilhe este código com quem você quiser convidar.</p>
        <div class="share-code-row">
          <span id="shareCodeValue" class="share-code" aria-live="polite">ABC 123</span>
          <button id="shareCopyBtn" class="icon-btn copy-btn" type="button" aria-label="Copiar código">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M8 8h9a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1Zm-2 9V6a1 1 0 0 1 1-1h9" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
        </div>
        <div id="shareCopyFeedback" class="share-feedback" role="status" aria-live="polite"></div>
        <button id="shareCloseBtn" class="btn share-close" type="button">Fechar</button>
      </div>
    </div>

    <!-- Composer overlay (hidden by default, appears above keyboard, with dim backdrop) -->
    <div id="composerBackdrop" class="composer-backdrop" role="dialog" aria-hidden="true" style="display:none">
      <div class="composer-overlay" role="document">
        <div class="composer-row">
          <button id="composerCheckbox" class="checkbox-round" aria-hidden="true" style="visibility:hidden">○</button>
          <input id="taskInput" placeholder="Adicionar uma tarefa" aria-label="Adicionar uma tarefa" autocomplete="off" />
          <button id="sendTask" class="send-btn" disabled aria-label="Enviar tarefa">↑</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-check.js';
    import { getDatabase, ref, set, get, child, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBH0WJNRyphdJQ1ydwgh1GYLnOS00wt4oM",
      authDomain: "to-do-8574b.firebaseapp.com",
      databaseURL: "https://to-do-8574b-default-rtdb.firebaseio.com",
      projectId: "to-do-8574b",
      storageBucket: "to-do-8574b.firebasestorage.app",
      messagingSenderId: "857849175598",
      appId: "1:857849175598:web:4664a8ad9b167af85509bf",
      measurementId: "G-E132M7DYY4"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    initializeAppCheck(firebaseApp, {
      provider: new ReCaptchaV3Provider('6LfoGtUrAAAAAI_hvP9snJSkpCkBjrGgHHWbxcup'),
      isTokenAutoRefreshEnabled: true,
    });
    const firebaseDb = getDatabase(firebaseApp);

    async function shareListToFirebase(code, list){
      if(!code || !list) throw new Error('Parâmetros inválidos');
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const payload = {
        title: list.title || 'Lista',
        tasks: Array.isArray(list.tasks)
          ? list.tasks.map(t=>({ text: t && t.text ? String(t.text) : '', done: !!(t && t.done) }))
          : [],
        updatedAt: Date.now()
      };
      await set(ref(firebaseDb, `sharedLists/${normalizedCode}`), payload);
    }

    async function getListFromFirebase(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const snapshot = await get(child(ref(firebaseDb), `sharedLists/${normalizedCode}`));
      if(snapshot.exists()){
        return snapshot.val();
      }
      return null;
    }

    async function deleteListFromFirebase(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      if(!normalizedCode) return;
      await remove(ref(firebaseDb, `sharedLists/${normalizedCode}`));
    }

    const activeSubscriptions = Object.create(null);

    function subscribeToList(code, handler){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      if(!normalizedCode || normalizedCode.length!==6) return;
      const pathRef = ref(firebaseDb, `sharedLists/${normalizedCode}`);
      const listener = (snapshot)=>{
        if(typeof handler === 'function'){
          handler(snapshot.exists() ? snapshot.val() : null);
        }
      };
      onValue(pathRef, listener);
      activeSubscriptions[normalizedCode] = { ref: pathRef, listener };
    }

    function unsubscribeFromList(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const sub = activeSubscriptions[normalizedCode];
      if(sub){
        off(sub.ref, 'value', sub.listener);
        delete activeSubscriptions[normalizedCode];
      }
    }

    window.firebaseShareList = shareListToFirebase;
    window.firebaseGetList = getListFromFirebase;
    window.firebaseDeleteList = deleteListFromFirebase;
    window.firebaseSubscribe = subscribeToList;
    window.firebaseUnsubscribe = unsubscribeFromList;
  </script>
  
  <script src="script.js?v=1.0.1"></script>
</body>
</html>
