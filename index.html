<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>To‑Do List</title>
  
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="style.css?v=1.0.1" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E132M7DYY4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-E132M7DYY4');
  </script>
</head>
<body>
  <div id="app" class="frame" role="application">
    <header class="appbar">
      <div class="appbar-left">
        <button id="globalBackBtn" class="back-btn" type="button" aria-label="Voltar" hidden>←</button>
        <div class="app-title-group">
          <div class="app-title" id="appTitle">To‑Do</div>
          <div class="app-subtitle" id="appSubtitle">Hoje</div>
        </div>
      </div>
      <div class="appbar-right">
        <button id="btnImportCode" class="icon-btn soft" type="button" aria-label="Importar lista por código" aria-haspopup="dialog">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 3h7v7H3V3zm2 2v3h3V5H5zm7-2h7v7h-7V3zm2 2v3h3V5h-3zM3 14h7v7H3v-7zm2 2v3h3v-3H5zm11-2h2v2h-2v-2zm4 0h2v2h-2v-2zm-4 4h2v2h-2v-2zm4 0h2v5h-5v-5h-1v-2h2v2h2z" fill="currentColor"></path>
          </svg>
          <span class="sr-only">Código</span>
        </button>
        <button id="appMenuBtn" class="icon-btn" type="button" aria-label="Mais opções" aria-haspopup="true" aria-expanded="false" hidden>⋮</button>
        <div id="appMenu" class="app-menu" role="menu" hidden>
          <button id="shareListAction" class="app-menu-item" type="button" role="menuitem">Compartilhar lista</button>
          <button id="resetAppAction" class="app-menu-item" type="button" role="menuitem">Resetar app</button>
          <button id="deleteListAction" class="app-menu-item" type="button" role="menuitem">Excluir Lista</button>
        </div>
      </div>
    </header>

    <!-- Screen: Lists -->
    <main id="screenLists" class="screen active" aria-label="Listas">
      <div class="lists" id="listsContainer">
        <div class="centered-empty" id="noLists">
          <div class="empty-illustration" aria-hidden="true">
            <svg viewBox="0 0 80 80" role="presentation" focusable="false">
              <rect x="12" y="16" width="56" height="48" rx="12" fill="var(--brand-50)" />
              <rect x="20" y="26" width="40" height="6" rx="3" fill="var(--brand-100, #DCE6FE)" />
              <rect x="20" y="38" width="32" height="6" rx="3" fill="var(--brand-100, #DCE6FE)" />
              <rect x="20" y="50" width="24" height="6" rx="3" fill="var(--brand-100, #DCE6FE)" />
            </svg>
          </div>
          <h2 class="empty-title">Crie sua primeira lista</h2>
          <p class="empty-description">Organize tarefas, estudos e ideias com um toque.</p>
          <button class="empty-cta" type="button">Nova lista</button>
        </div>
      </div>
      <button id="btnNewList" class="fab-primary" type="button" aria-haspopup="dialog" aria-label="Nova lista">
        <span class="icon">＋</span>
        <span class="sr-only">Nova lista</span>
      </button>
    </main>

    <!-- Screen: Single List -->
    <section id="screenListDetail" class="screen" aria-label="Detalhes da Lista">
      <div class="list-header">
        <div style="display:flex;align-items:center;gap:8px">
          <div id="currentListName" class="list-name" tabindex="0" role="button" aria-haspopup="dialog">Título</div>
        </div>
      </div>

      <div class="tasks" id="tasksContainer" aria-live="polite"></div>

      <!-- completed group -->
      <div id="completedGroup" style="display:none">
        <div id="completedHeader" class="completed-header" role="button" tabindex="0">
          <span id="chev">▾</span>
          <span>Concluída</span>
          <span class="count" id="completedCount">0</span>
        </div>
        <div id="completedList" class="tasks"></div>
      </div>

      <!-- Floating + (right) -->
      <button id="openComposer" class="fab" aria-label="Adicionar">+</button>
      
      <!-- Lixeira para exclusão por drag and drop -->
      <div id="trashZone" class="trash-zone" hidden aria-label="Arrastar aqui para excluir">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
        </svg>
      </div>
    </section>

    <!-- Screen: Task Detail -->
    <section id="screenTaskDetail" class="screen" aria-label="Tarefa">
      <div class="task-detail">
        <div class="task-detail-row" id="taskDetailRow">
          <button id="taskDetailCheckbox" class="checkbox-round" aria-label="Concluir tarefa"></button>
          <div id="taskDetailText" class="text" contenteditable="true" spellcheck="false" aria-label="Editar tarefa"></div>
        </div>

        <section class="task-media" aria-label="Fotos da tarefa">
          <h2 class="task-media-title">Fotos</h2>
          <div id="taskPhotoGrid" class="photo-grid" role="list" aria-live="polite">
            <div class="photo-grid-empty" role="status">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 6a2 2 0 0 1 2-2h2.172a2 2 0 0 1 1.414.586l.828.828H18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Zm2 0v10h12V8h-7.172a2 2 0 0 1-1.414-.586L8.586 6H6Zm6 3a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z" fill="currentColor" />
              </svg>
              <p>Adicione uma foto</p>
            </div>
          </div>
        </section>

        <div class="task-media-footer" role="group" aria-label="Opções de foto">
          <button class="btn primary photo-action" type="button">
            <span class="photo-action-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path d="M4 7a3 3 0 0 1 3-3h2.172a3 3 0 0 1 2.121.879l.828.828H16a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Zm7 3a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm8-5v2h2V5h-2Z" fill="currentColor" />
              </svg>
            </span>
            Tirar Foto
          </button>
          <button class="btn photo-action" type="button">Galeria</button>
        </div>
      </div>

      <div id="photoLightbox" class="photo-lightbox" role="dialog" aria-modal="true" aria-hidden="true" hidden>
        <div class="photo-lightbox-content">
          <img id="photoLightboxImage" src="" alt="Pré-visualização da foto selecionada" />
          <button type="button" class="photo-lightbox-btn close" aria-label="Fechar visualização">Fechar</button>
          <button type="button" class="photo-lightbox-btn delete">Excluir</button>
        </div>
      </div>
    </section>

    <!-- Modal (Create / Rename) -->
    <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="modal" role="document">
        <h3 id="modalTitle">Nova Lista</h3>
        <div class="modal-body">
          <input id="listNameInput" type="text" placeholder="Nome da lista" aria-label="Nome da lista" />
        </div>
        <div class="actions">
          <button id="modalCancel" class="btn">Cancelar</button>
          <button id="modalPrimary" class="btn primary" disabled>Criar lista</button>
        </div>
      </div>
    </div>

    <!-- Code Import Modal -->
    <div id="codeBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="modal" role="document">
        <h3 id="codeModalTitle">Código</h3>
        <div class="modal-body">
          <div class="code-inputs" role="group" aria-label="Código de 6 dígitos">
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 1" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 2" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 3" maxlength="1" />
            <span class="code-gap" aria-hidden="true" style="width:10px"></span>
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 4" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 5" maxlength="1" />
            <input class="code-input" inputmode="latin" autocomplete="one-time-code" aria-label="Dígito 6" maxlength="1" />
          </div>
        </div>
        <div class="actions">
          <button id="codeCancel" class="btn">Cancelar</button>
          <button id="codeImport" class="btn primary" disabled>Importar lista</button>
        </div>
      </div>
    </div>

    <!-- Share Code Dialog -->
    <div id="shareBackdrop" class="share-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="share-dialog" role="document">
        <h3 class="share-title">Compartilhar Lista</h3>
        <p class="share-instructions">Compartilhe este código com quem você quiser convidar.</p>
        <div class="share-code-row">
          <span id="shareCodeValue" class="share-code" aria-live="polite">ABC 123</span>
          <button id="shareCopyBtn" class="icon-btn copy-btn" type="button" aria-label="Copiar código">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M8 8h9a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1Zm-2 9V6a1 1 0 0 1 1-1h9" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
        </div>
        <div id="shareCopyFeedback" class="share-feedback" role="status" aria-live="polite"></div>
        <button id="shareCloseBtn" class="btn share-close" type="button">Fechar</button>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
      <div class="modal confirm-modal" role="document">
        <h3 id="confirmTitle" class="confirm-title">Confirmar ação</h3>
        <p id="confirmMessage" class="confirm-message"></p>
        <div class="actions">
          <button id="confirmCancel" class="btn" type="button">Cancelar</button>
          <button id="confirmPrimary" class="btn primary" type="button">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Composer overlay (hidden by default, appears above keyboard, with dim backdrop) -->
    <div id="composerBackdrop" class="composer-backdrop" role="dialog" aria-hidden="true" style="display:none">
      <div class="composer-overlay" role="document">
        <div class="composer-row">
          <button id="composerCheckbox" class="checkbox-round" aria-hidden="true" style="visibility:hidden">○</button>
          <input id="taskInput" placeholder="Adicionar uma tarefa" aria-label="Adicionar uma tarefa" autocomplete="off" />
          <button id="sendTask" class="send-btn" disabled aria-label="Enviar tarefa">↑</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-check.js';
    import { getDatabase, ref, set, get, child, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBH0WJNRyphdJQ1ydwgh1GYLnOS00wt4oM",
      authDomain: "to-do-8574b.firebaseapp.com",
      databaseURL: "https://to-do-8574b-default-rtdb.firebaseio.com",
      projectId: "to-do-8574b",
      storageBucket: "to-do-8574b.firebasestorage.app",
      messagingSenderId: "857849175598",
      appId: "1:857849175598:web:4664a8ad9b167af85509bf",
      measurementId: "G-E132M7DYY4"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    initializeAppCheck(firebaseApp, {
      provider: new ReCaptchaV3Provider('6LfoGtUrAAAAAI_hvP9snJSkpCkBjrGgHHWbxcup'),
      isTokenAutoRefreshEnabled: true,
    });
    const firebaseDb = getDatabase(firebaseApp);

    const MAX_SHARED_PHOTOS = 4;
    const MAX_SHARED_PHOTO_DATA_LENGTH = 400000; // ~400 KB
    const MAX_SHARED_PAYLOAD_SIZE = 7 * 1024 * 1024; // 7 MB

    function createSharedPhotoId(){
      return 'p_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2, 8);
    }

    function sanitizeSharedPhoto(photo, seenIds){
      if(!photo || typeof photo !== 'object') return null;
      const rawDataUrl = typeof photo.dataUrl === 'string' ? photo.dataUrl.trim() : '';
      if(!rawDataUrl || rawDataUrl.length > MAX_SHARED_PHOTO_DATA_LENGTH){
        return null;
      }
      let id = typeof photo.id === 'string' ? photo.id.trim() : '';
      if(!id){ id = createSharedPhotoId(); }
      while(seenIds.has(id)){ id = createSharedPhotoId(); }
      const createdAtNum = Number(photo.createdAt);
      return {
        id,
        dataUrl: rawDataUrl,
        createdAt: Number.isFinite(createdAtNum) ? createdAtNum : Date.now()
      };
    }

    function sanitizeSharedTask(task){
      const photos = [];
      const seen = new Set();
      if(task && Array.isArray(task.photos)){
        for(const entry of task.photos){
          const sanitized = sanitizeSharedPhoto(entry, seen);
          if(sanitized){
            seen.add(sanitized.id);
            photos.push(sanitized);
            if(photos.length >= MAX_SHARED_PHOTOS){ break; }
          }
        }
      }
      return {
        text: task && typeof task.text === 'string' ? task.text : '',
        done: !!(task && task.done),
        photos
      };
    }

    function trimSharedPayloadToLimit(payload){
      if(!payload || !Array.isArray(payload.tasks)){
        return payload;
      }
      const photoRefs = [];
      payload.tasks.forEach((task)=>{
        if(!Array.isArray(task.photos)){
          task.photos = [];
          return;
        }
        const unique = [];
        const seen = new Set();
        task.photos.forEach((photo)=>{
          if(photo && !seen.has(photo.id)){
            seen.add(photo.id);
            unique.push(photo);
          }
        });
        task.photos = unique;
        unique.forEach((photo)=>{ photoRefs.push({ task, photo }); });
      });
      let serialized = '';
      try{ serialized = JSON.stringify(payload); }
      catch(_){ serialized = ''; }
      photoRefs.sort((a,b)=>{
        const lenA = (a.photo && typeof a.photo.dataUrl === 'string') ? a.photo.dataUrl.length : 0;
        const lenB = (b.photo && typeof b.photo.dataUrl === 'string') ? b.photo.dataUrl.length : 0;
        return lenB - lenA;
      });
      while(serialized.length > MAX_SHARED_PAYLOAD_SIZE && photoRefs.length){
        const { task, photo } = photoRefs.shift();
        if(task && Array.isArray(task.photos)){
          const idx = task.photos.indexOf(photo);
          if(idx !== -1){ task.photos.splice(idx, 1); }
        }
        try{ serialized = JSON.stringify(payload); }
        catch(_){ serialized = ''; }
      }
      return payload;
    }

    function buildSharedPayload(list){
      const tasks = Array.isArray(list && list.tasks)
        ? list.tasks.map((task)=> sanitizeSharedTask(task))
        : [];
      const payload = {
        title: list && typeof list.title === 'string' ? list.title : 'Lista',
        tasks,
        updatedAt: Date.now()
      };
      return trimSharedPayloadToLimit(payload);
    }

    function normalizeRemoteListData(raw){
      if(!raw || typeof raw !== 'object'){ return null; }
      const normalized = {
        title: typeof raw.title === 'string' ? raw.title : 'Lista',
        updatedAt: raw.updatedAt ? Number(raw.updatedAt) : Date.now(),
        tasks: Array.isArray(raw.tasks)
          ? raw.tasks.map((task)=> sanitizeSharedTask(task))
          : []
      };
      return normalized;
    }

    async function shareListToFirebase(code, list){
      if(!code || !list) throw new Error('Parâmetros inválidos');
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const payload = buildSharedPayload(list);
      await set(ref(firebaseDb, `sharedLists/${normalizedCode}`), payload);
    }

    async function getListFromFirebase(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const snapshot = await get(child(ref(firebaseDb), `sharedLists/${normalizedCode}`));
      if(snapshot.exists()){
        return normalizeRemoteListData(snapshot.val());
      }
      return null;
    }

    async function deleteListFromFirebase(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      if(!normalizedCode) return;
      await remove(ref(firebaseDb, `sharedLists/${normalizedCode}`));
    }

    const activeSubscriptions = Object.create(null);

    function subscribeToList(code, handler){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      if(!normalizedCode || normalizedCode.length!==6) return;
      const pathRef = ref(firebaseDb, `sharedLists/${normalizedCode}`);
      const listener = (snapshot)=>{
        if(typeof handler === 'function'){
          const payload = snapshot.exists() ? normalizeRemoteListData(snapshot.val()) : null;
          handler(payload);
        }
      };
      onValue(pathRef, listener);
      activeSubscriptions[normalizedCode] = { ref: pathRef, listener };
    }

    function unsubscribeFromList(code){
      const normalizedCode = String(code).replace(/[^0-9A-Z]/gi,'').toUpperCase().slice(0,6);
      const sub = activeSubscriptions[normalizedCode];
      if(sub){
        off(sub.ref, 'value', sub.listener);
        delete activeSubscriptions[normalizedCode];
      }
    }

    window.firebaseShareList = shareListToFirebase;
    window.firebaseGetList = getListFromFirebase;
    window.firebaseDeleteList = deleteListFromFirebase;
    window.firebaseSubscribe = subscribeToList;
    window.firebaseUnsubscribe = unsubscribeFromList;
    window.firebaseReady = true;
    try{
      window.dispatchEvent(new Event('firebase-ready'));
    }catch(_){ }
  </script>
  
  <script src="script.js?v=1.0.1"></script>
</body>
</html>
